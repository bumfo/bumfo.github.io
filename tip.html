<!DOCTYPE html>
<meta name=viewport content="width=device-width, initial-scale=1.0, maximum-scale=1">

<title>tip</title>

<style>
  html {
    font: 16px/24px "Segoe UI", helvetica, sans-serif;
  }
  body {
    margin: 32px;
  }
  pre {
    white-space: pre-line;
  }
  u {
    text-decoration-line: underline;
    text-decoration-style: wavy;
  }
</style>

<pre>
  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Quisque vel condimentum quam. Donec sollicitudin ut sem non commodo. Ut at purus a enim rhoncus malesuada ut vitae sem. Integer efficitur et quam non interdum. Aenean aliquam euismod semper. Duis vestibulum, nunc nec egestas sollicitudin, est nunc tincidunt lectus, eu tristique nisi mauris quis enim. Sed ac erat vitae nulla consectetur pellentesque at sit amet enim. Praesent interdum consequat gravida. Sed bibendum, massa non egestas faucibus, lectus velit ultrices mi, vel feugiat lacus libero eget lacus. Etiam feugiat velit ac urna dictum lacinia vitae et sem. Aliquam venenatis mattis eleifend.
  
  Fusce bibendum arcu vitae tortor varius eleifend. Sed ut ultrices ex, sit amet accumsan massa. Mauris interdum neque at justo eleifend, a auctor nulla elementum. Praesent eu tortor at urna pulvinar pharetra. Maecenas sit amet efficitur erat. Nulla facilisi. Aliquam et massa finibus, porttitor leo in, ornare libero. Maecenas risus massa, pulvinar vel sagittis aliquam, varius vel dolor. Donec at scelerisque velit. Fusce pulvinar consequat nulla, a dignissim lectus. Nullam ac ante pulvinar, sollicitudin ante id, mollis mauris. Vestibulum aliquam quis lectus vitae venenatis. Etiam nisi nisl, egestas id imperdiet vel, bibendum ac libero. Mauris sodales faucibus lectus vitae tincidunt. Aliquam lacinia quam dui, id rhoncus velit faucibus in. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas.
  
  Suspendisse finibus, felis at venenatis accumsan, dolor ligula accumsan odio, vel aliquet tortor ex sed massa. Aliquam vitae augue non dolor rhoncus efficitur. Vestibulum a neque eget urna pretium cursus id in tortor. Pellentesque nec nibh tincidunt tellus tempor bibendum lacinia ut dui. Nam ultricies leo in turpis ultrices pulvinar. Cras nec leo ultricies, elementum nisl ut, viverra mi. Cras sollicitudin dui vel egestas mollis. Donec sit amet sollicitudin sem. Donec viverra enim id nisl tincidunt consectetur. Integer ut sagittis augue. Suspendisse quis vehicula purus, in porttitor mi. Nullam vel lacinia dolor, vel cursus dui. Quisque sed mauris ligula. Nulla nec felis nec orci ultrices tempus id sed dolor. Vivamus euismod nunc enim, ac hendrerit enim hendrerit id. Donec imperdiet eu sapien sit amet ultrices.
  
  Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam pulvinar bibendum imperdiet. Maecenas sagittis diam id lacinia sollicitudin. Proin at leo in est ornare vulputate. Ut eget purus vitae nisl condimentum malesuada sed quis dui. Curabitur rhoncus nec metus quis malesuada. Duis in interdum diam. In hac habitasse platea dictumst. Nam dictum neque id cursus tempor.
  
  Nunc hendrerit feugiat maximus. Vivamus pretium ultrices mauris sagittis vehicula. Morbi tristique at turpis vel pharetra. Aenean porta pellentesque quam. Nam sodales quam at mi placerat aliquet. Duis fermentum leo ac nunc sagittis, nec rhoncus metus suscipit. Etiam eget ex id metus ullamcorper porta vel eu lorem. Nam vehicula velit a molestie dapibus. Morbi felis risus, rhoncus in lacus efficitur, condimentum ultricies ligula. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Sed gravida euismod sapien, eget imperdiet dolor vulputate non. Quisque et ullamcorper lorem, non imperdiet neque.
  
  Morbi hendrerit dolor nulla, id iaculis leo molestie vel. Pellentesque consequat, ligula non mollis egestas, neque enim semper dui, a imperdiet arcu nulla ut sapien. Nullam id malesuada augue. Vivamus id erat at lorem mattis semper in congue odio. Donec rhoncus facilisis justo eget iaculis. Nunc id lectus sed ante tempor accumsan. Nulla facilisi. Fusce laoreet pharetra ullamcorper. Praesent mollis vehicula suscipit. Etiam et lacus at metus pharetra congue. Proin pretium nisl non lobortis vulputate. Maecenas faucibus urna sapien, eget scelerisque orci fringilla nec. Pellentesque consectetur ligula lectus, sit amet dapibus arcu pretium sed. Nullam maximus metus lobortis odio rutrum ornare.
  
  Nullam semper in sapien at venenatis. In sapien diam, malesuada nec lectus scelerisque, pellentesque bibendum velit. Cras et pellentesque urna. Pellentesque mauris nulla, malesuada aliquam sagittis at, posuere nec mi. Quisque in augue eros. Mauris rutrum sodales eleifend. Sed sit amet mauris a leo molestie scelerisque. Nam nec enim sit amet augue faucibus pretium ut in arcu. Donec vitae porta felis, et accumsan libero. Donec dictum sem dui, vel scelerisque lacus maximus sed. Interdum et malesuada fames ac ante ipsum primis in faucibus. Nulla tortor urna, aliquet eu justo ac, commodo ullamcorper purus.
  
  Vestibulum ornare tincidunt tincidunt. Donec vehicula, neque a accumsan fermentum, risus lectus gravida eros, vitae egestas lectus diam id metus. Mauris blandit ligula nec ornare gravida. Praesent pretium neque non diam varius placerat. Nulla facilisi. Sed interdum rutrum odio non auctor. Donec urna massa, euismod sed vulputate eu, tincidunt non justo. Cras nec sapien est. Praesent purus sapien, porta eu porta a, auctor at odio.
  
  Praesent vel auctor metus. Sed sit amet ex metus. In hac habitasse platea dictumst. Fusce quam orci, tempor in mattis et, tristique nec arcu. Cras eget rutrum libero. Maecenas tincidunt eros eu nulla dapibus hendrerit. Cras pellentesque risus in vestibulum rhoncus.
  
  Phasellus in tellus id dui imperdiet fringilla vitae eu metus. Maecenas ante ligula, hendrerit dapibus bibendum quis, venenatis a velit. Vestibulum pellentesque nunc tristique eleifend molestie. Vivamus eget nibh urna. Donec rutrum ipsum sit amet massa laoreet, quis consectetur lectus molestie. Donec nec ante mi. Vestibulum vehicula dignissim odio, et euismod tellus feugiat nec. Donec sit amet viverra justo. Curabitur neque urna, porttitor eget mauris sit amet, luctus malesuada velit. Morbi eros massa, accumsan id vestibulum ac, mollis vitae sem. Pellentesque ante enim, congue vitae sem pellentesque, imperdiet varius orci. In nec dapibus nisl, lacinia convallis justo. Nam ultrices tellus vitae urna ullamcorper tincidunt. Aenean eu posuere elit, vel pretium elit.
</pre>

<script>
  var wrong = /\b(?:dolor)\b/g;
  var p = document.querySelector('pre');

  var text = p.textContent;

  var p2 = document.createElement('pre');

  function throttle(f, t) {
    var d = null;
    return function () {
      if (d === null) {
        d = setTimeout(function () {
          d = null;
          f();
        }, t);
      }
    }
  }

  function cancelableThrottle(f, t) {
    var d = null;

    function call() {
      if (d === null) {
        d = setTimeout(function () {
          d = null;
          f();
        }, t);
      }
    }

    function cancel() {
      clearTimeout(d);
      d = null;
    }

    call.cancel = cancel;

    return call;
  }

  function Tip() {
    var tip = document.createElement('div');
    tip.style = 'position: absolute; background: #eee; border: 1px solid #ddd; pointer-events: none';
    document.body.appendChild(tip);

    function show(content, el) {
      var box = el.getBoundingClientRect();
      var x = box.x + box.width / 2;
      var y = box.y + box.height;

      tip.style.display = 'block';
      tip.textContent = content;
      tip.style.left = 0;
      tip.style.top = 0;

      var rect = tip.getBoundingClientRect();

      var ww = window.innerWidth || document.documentElement.clientWidth;
      var wh = window.innerHeight || document.documentElement.clientHeight;

      var w = rect.width;
      var h = rect.height;

      var xx = x - w / 2;
      var yy = y;

      if (xx < 8) {
        xx = 8;
      }
      if (xx + w > ww - 8) {
        xx = ww - 8 - w;
      }
      if (yy < 8) {
        yy = 8;
      }
      if (yy + h > wh - 8) {
        yy = y - h - box.height;
      }
      if (yy + h > wh - 8) {
        yy = wh - 8 - h;
      }

      tip.style.left = xx + window.scrollX + 'px';
      tip.style.top = yy + window.scrollY + 'px';
    }

    function hide() {
      tip.style.display = 'none';
    }

    return {
      'show': show,
      'hide': hide,
    }
  }

  var tip = Tip();

  function TipControl(el, title) {
    var shown = false;

    function show() {
      tip.show(title, el);
      shown = true;
    }

    function hide() {
      tip.hide();
      shown = false;
    }

    var d = null;

    show = cancelableThrottle(show, 300);
    hide = cancelableThrottle(hide, 300);

    el.addEventListener('mousemove', function (e) {
      hide.cancel();

      if (!shown) {
        show();
      }
    });

    el.addEventListener('mouseout', function (e) {
      show.cancel();

      if (shown) {
        hide();
      }
    });
  }

  function Wavy(x) {
    var y = document.createElement('u');
    y.textContent = x;

    TipControl(y, 'Hello World, Hello China, Hello Beijing');

    return y;
  }

  function debug(x) {
    console.log(x);
    return x;
  }

  var result;
  var j = 0;
  while ((result = wrong.exec(text)) !== null) {
    var m = result[0];
    var i = result.index;

    p2.appendChild(document.createTextNode(debug(text.substring(j, i))));
    p2.appendChild(Wavy(debug(m)));

    j = i + m.length;
  }
  p2.appendChild(document.createTextNode(debug(text.substring(j))));

  p.parentNode.replaceChild(p2, p);

</script>
